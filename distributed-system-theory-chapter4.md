---
title: 分布式理论（四）
date: 2015-02-20 10:00:00
tags: 分布式理论，数据副本
author: maclaon
comments: false
---
# 基本副本协议
副本控制协议指按特定的协议流程控制副本数据的读写行为，使得副本满足一定的可用性和一致性要求的分布式协议。副本控制协议要具有一定的对抗异常状态的容错能力，从而使得系统具有一定的可用性，同时副本控制协议要能供一定一致性级别。由CAP原理可知，**要设计一种满足强一致性，且在出现任何网络异常时都可用的副本协议是不可能的**。

> 副本控制协议分为两大类: 中心化副本控制协议和去中心化副本控制协议

一个不恰当的例子，中心化副本控制协议类似专制制度，系统效率高但高度依赖于中心节点，一旦中心节点异常，系统受到的影响较大；去中心化副本控制协议类似于民主制度，节点集体协商，效率低下，但个别节点的异常不会对系统总体造成太大影响。


## 中心化副本控制协议
> 中心化副本控制协议的基本思路是由一个中心节点协调副本数据的更新、维护副本之间的一致性。

中心化副本控制协议的优点是协议相对较为简单，所有的副本相关的控制交由中心节点完成，并发控制将由中心节点完成，从而使得一个分布式并发控制问题，简化为一个单机并发控制问题。所谓并发控制，即多个节点同时需要修改副本数据时，需要解决“写写”、“读写”等并发冲突。单机系统上常用加锁等方式进行并发控制。对于分布式并 发控制，加锁也是一个常用的方法，但如果没有中心节点统一进行锁管理，就需要完全分布式化的锁系统，会使得协议非常复杂。如下图所示:

![](http://oh8mi0yav.bkt.clouddn.com/center-data-replic-control-protocal-in-distribute-system.png)

<!--more-->

### 优缺点
优点:
+ 副本一致性有单机的性质来控制，便于管理和协调

缺点:
+ 可用性依赖于中心化节点，当中心节点异常或与中心节点通信中断时，系统将失去某些服务(通常至少失去更新服务)，所以中心化副本控制协议的缺点正是存在一定的停服务时间。

### primary-secondary协议

在primary-secondary类型的协议中，副本被分为两大类，其中有且仅有一个副本作为primary副本，除 primary以外的副本都作为secondary副本。维护primary副本的节点作为中心节点，中心节点负责维护数据的更新、并发控制、协调副本的一致性。

> primary-secondary协议主要解决四大类问题: 数据更新流程、数据读取方式、Primary副本的确定和切换、数据同步。

#### 数据更新流程
primary-secondary协议的数据更新流程:
> 1. 数据更新都由primary节点协调完成
> 2. 外部节点将更新操作发给primary节点
> 3. primary节点进行并发控制即确定并发更新操作的先后顺序
> 4. primary节点将更新操作发送给secondary节点
> 5. primary根据secondary节点的完成情况决定更新是否成功并将结果返回外部节点。

![](http://oh8mi0yav.bkt.clouddn.com/primary-secondary-data-replica-protocal.png)

上述数据更新对于副本一致性根据系统的不同特性，有着不同的结果，在提供最终一致性服务的系统中，secondary可以与primary不一致，只要后续secondary节点可以慢慢同步到与primary一致的状态即可满足最终一致性的要求。

#### 数据读取方式
与数据更新流程类似，读取方式也与一致性高度相关，如果只需要最终一致性，则读取任何副本都可以满足需求。如果需要会话一致性，则可以为副本设置版本号，每次更新后递增版本号，用户读取副本时验证版本号，从而保证用户读到数据在会话范围内单调递增，**但是primary-secondary比较困难是实现强一致性**。

##### 实现强一致性的几种思路
+ 由于数据的更新流程都是由primary控制，primary副本上的数据是最新的，所以读取primary副本上可以实现强一致性，但是带来的问题是primary节点的性能问题。
+ 实际中按照数据段为单位维护副本，仅有primary副本的机器会浪费很多资源，实际上将数据进行分段，把primary和secondary的副本分散到集群中，这样就保证每台机器上都有一些数据的primary副本，也有另一些数据段的secondary的副本，**Elasticsearch中的分片的分布就是类似于此**。
+ 由primary控制节点secondary的可用性与否。当primary更新某个secondary副本不成功时，primary将该secondary副本标记为不可用，从而用户不再读取该不可用副本。
+ 鸽笼原理
+ 基于Quorum机制


#### Primary副本的确定和切换
在primary-secondary类型的协议中，另一个核心问题是如何确定定primary副本，尤其是在原primary副本所在机器出现宕机异常时，需要有某种机制切换primary副本，使得某个secondary副本成为新的primary副本。
通常的在primary-secondary类型的分布式系统中，哪个副本是primary这一信息都属于元信息，有专门的元数据服务器维护。执行更新操作时，首先查询元数据服务器获取副本的primary信息，从而进一步执行数据更新流程。

> **问题的关键是如何对副本出现情况下再出现对应的策略。**

#### 数据同步
使用日志或者快照

## 去中心化副本控制协议

去中心化副本是另一类较为复杂的副本控制协议。与中心化副本系统协议最大的不同是去中心化副本控制协议没有中心节点，协议中所有的节点都是完全对等，节点之间通过平等协商达到一致。

![](http://oh8mi0yav.bkt.clouddn.com/data-replic-no-center-node-in-distribute-system.png)

**Paxos是唯一在工程中得到应用的强一致性去中心化副本控制协议**。