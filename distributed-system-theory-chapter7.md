---
title: 分布式理论（七）
date: 2015-03-22 10:00:00
tags: 分布式理论，两阶段提交协议
author: maclaon
comments: false
---
# 两阶段提交协议
两阶段交协议是一种典型的“中心化副本控制”协议。在该协议中，参与的节点分为两类: 一个中心化协调者节点(coordinator)和N个参与者节点(participant)。每个参与者节点可以是管理数据库副本的节点。两阶段交的思路比较简单，在第一阶段协调者询问所有的参与者是否可以交事务(请参与者投票)，所有参与者向协调者投票。在第二阶段，协调者根据所有参与者的投票结果做出是否事务可以全局提交的决定，并通知所有的参与者执行该决定。在一个两阶段交流程中，参与者不能改变自己的投票结果。两阶段交协议的可以全局提交的前提是所有的参与者都同意提交事务，只要有一个参与者投票选择放弃(abort)事务，则事务必须被放弃。

## 流程

![](http://oh8mi0yav.bkt.clouddn.com/two-phase-commit-process-in-distribute-system.png)

<!--more-->
### 阶段一
> + 事务询问: 协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。
> + 执行事务: 各参与者节点执行事务操作，**并将Undo和Redo信息记入事务日志中**。
> + 各参与者向协调者反馈事务询问的响应。

### 执行事务提交
协调者会根据各参与者的反馈情况来决定最终是否可以进行事务提交操作，结果如下: 
+ 执行事务提交
	+ 发送提交请求: 协调者向所有参与者节点发出Commit请求。
	+ 事务提交: 参与者接收Commit请求后，会正式执行事务提交操作，并在完成提交之后释放整个在事务执行期间占用的事务资源。
	+ 反馈事务提交结果: 参与者在完成事务提交之后，向协调者发送Ack消息。
	+ 完成事务: 协调者接收到所有参与者反馈的Ack消息后，完成事务。
+ 中断事务
	+ 发送回滚请求: 协调者向所有参与者节点发出RollBack请求
	+ 事务回滚: 参与者接收到Rollback请求后，会利用其在阶段中的日志技术的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。
	+ 反馈事务回滚结果: 参与者在完成事务回滚之后，向协调者发送Ack消息。
	+ 中断事务: 协调者接收到搜有参与者反馈的Ack消息后，完成事务中断。


## 两阶段
两阶段提交在数据库领域内，为了基于分布式系统架构下的所有节点在进行事务处理过程中能够保持原子性和一致性而设计的一种算法，是一种一致性协议，用来保证分布式系统数据的一致性。两阶段主要解决数据库中事务的问题，具体可以看[Java事务理论](http://shieldme.cn/2015/03/29/java-mysql-transaction-theory/).

### 优缺点
**分析协议优缺点从协议中节点的状态失效情况下，会引起哪些问题来入手，从并发，性能，可扩展性，数据迁移等几个方面点逐一形成逻辑严谨的考察**。
> + 优点: 原理简单、实现方便
> + 缺点: 同步阻塞、单点问题

### 整体性学习
第一阶段，张老师作为“协调者”，给小强和小明（参与者、节点）发微信，组织他们俩明天8点在学校门口集合，一起去爬山，然后开始等待小强和小明答复。

第二阶段，如果小强和小明都回答没问题，那么大家如约而至。如果小强或者小明其中一人回答说“明天没空，不行”，那么张老师会立即通知小强和小明“爬山活动取消”。

细心的读者会发现，这个过程中可能有很多问题的。如果小强没看手机，那么张老师会一直等着答复，小明可能在家里把爬山装备都准备好了却一直等着张老师确认信息。更严重的是，如果到明天8点小强还没有答复，那么就算“超时”了，那小明到底去还是不去集合爬山呢？

这就是两阶段提交协议的弊病，所以后来业界又引入了三阶段提交协议来解决该类问题。





