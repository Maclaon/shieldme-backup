---
title: 分布式理论（六）
date: 2015-03-15 10:00:00
tags: 分布式理论，日志技术
author: maclaon
comments: false
---
# 日志技术
**日志技术是宕机回复的主要技术之一**。日志技术最初使用在数据库系统中，严格来说日志技术不是一种分布式系统的技术，但在分布式系统中广泛使用了日志技术做宕机回复。

## Redo Log
Redo Log是一种非常简单实用的日志技术。流程如下：
> + 将更新操作的结果以追加写的方式写入磁盘的日志文件
> + 按更新操作修改内存中的数据
> + 返回更新成功

从 Redo Log的流程可以看出，Redo写入日志的是更新操作完成后的结果，且由于是顺序追加写日志文件，在磁盘等对顺序写有力的存储设备上效率较高。

> 用 Redo Log进行宕机恢复非常简单，只需要“回放”日志即可。从头读取日志文件中的每次更新操作的结果，用这些结果修改内存中的数据。

## Check Point
宕机恢复流量的缺点是需要回放所有redo日志，效率较低，假如需要恢复的操作非常多，那么这个宕机恢复过程将非常漫长。解决这一问题的方法即引入check point技术。在简化的模型下，check point技术的过程即将内存中的数据以某种易于重新加载的数据组织方式完整的dump到磁盘，从而减少宕机恢复时需要回放的日志数据。

<!--more-->

### Check Point写入
+ 向日志文件中记录“Begin Check Point”标志
+ 将内存中的数据以某种易于重新加载的数据组织方式dump到磁盘上
+ 向日志文件中记录"End Check Point"标志

### Check Point宕机恢复
+ 将dump到磁盘的数据加载到内存
+ 从后向前扫描日志文件，寻找最后一个“End Check Point”日志
+ 从最后一个"End Check Point"日志向前找到最近一个"Begin Check Point"日志，并回放该日志之后的所有更新操作日志。

上述check point的方式依赖redo日志中记录的都是更新后的数据结果这一特征，所以即使dump的数据已经包含了某些操作的结果，重新回放这些操作的日志也不会造成数据错误。同一条日志可以重复回放的操作即所谓具有“幂等性”的操作。工程中，有些时候Redo日志无法具有幂等性，例如加法操作、append 操作等。此时dump 的内存数据一定不能包括“begin check point”日志之后的操作。为此有两种方法: 其一是check point 的过程中停更新服务，不再进行新的操作；另一种方法是，设计一种支持快照(snapshot)的内存数据结构，可以快速的将内存生成快照，然后写入check point日志再dump快照数据。至于如何设计支持快照的内存数据结构，方式也很多，例如假设内存数据结构维护key-value值，那么可以使用哈希表的数据结构，当做快照时，新建一个哈希表接收新的更新，原哈希表用于dump数据，此时内存中存在两个哈希表，查询数据时查询两个哈希表并合并结果。



