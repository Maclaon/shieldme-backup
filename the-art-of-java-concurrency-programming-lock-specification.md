---
title: Java并发编程艺术之Java中的锁
date: 2015-07-13 10:00:00
tags: 并发编程，Java中的锁
author: maclaon
comments: false
---
# Java中的锁
> 锁是用来控制多个线程访问共享资源的方式，一般来说，一个锁能够防止多个线程同时访问共享资源(但是有些锁可以允许多个线程并发的访问共享资源，比如读写锁)。Java程序原先是靠`synchronized`关键字实现锁的功能，后续Java提供了基于`Lock`接口（以及相关实现类）用来实现锁的功能，使用时显式地获取和释放锁。虽然缺少了（通过`synchronized`块或者方法所提供的）隐式获取释放锁的便捷性，但却拥有了锁获取与释放的可操作性、可中断性的获取锁以及超时获取锁等多种`synchronized`关键字所不具备的同步性。

**不要将获取锁的过程卸载`try`块中，因为如果获取锁(自定义实现)时发生了异常，异常抛出的同时，也会导致锁无故释放。**

## 队列同步器
队列同步器`AbstractQueuedSynchronizer`，是用来构建锁或者其他同步组件的基础框架，它使用了一个`int`成员变量表示同步状态，通过内置的`FIFO`队列来完成资源获取线程的排队工作，它的主要使用方法是继承，子类通过继承同步器并实现它的抽象方法来管理同步状态，在抽象方法的实现过程中免不了要对同步状态进行更改，这时就需要使用如下三个方法，保证对任何状态进行改变都是安全的:

|方法名|作用|
|:--|:--|
|getState()|获取当前同步状态|
|setState(int newState)|设置当前同步状态|
|compareAndSetState(int expect, int update)|CAS乐观锁设置当前状态，保证原子性|

> 建议子类被定义为自定义同步组件的静态内部类，同步器自身没有实现任何同步接口，它仅仅是定义了若干同步状态获取和释放的方法来供自己同步组件使用。

同步器是实现锁(也可以是任何同步组件)的关键，在锁的实现中聚合同步器，利用同步器实现锁的语义，可以理解如下：
+ 锁是面向使用者的，它定义了使用者与锁交互的接口(比如可以允许两个线程并行访问)，隐藏了实现细节；
+ 同步器面向的锁的实现者，它简化了锁的实现方式，屏蔽了同步状态管理，线程的排队，等待与唤醒等底层操作。