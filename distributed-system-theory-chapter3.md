---
title: 分布式理论（三）
date: 2015-01-28 10:00:00
tags: 分布式理论，数据分布
author: maclaon
comments: false
---
# 分布式系统原理
## 数据分布方式
利用多台计算机协同解决单台计算机不能解决的计算、存储等问题。将一个单机问题使用分布式解决，首先要解决的就是如何将问题拆解为可以使用多机分布式解决，使得分布式系统中的每台机器负责原问题的一个子集。所以单台机器上如何拆解具体的输入数据成为分布式系统的基本问题。这里介绍几种常用的数据拆解方式。

### 哈希方式
哈希方式是最常见的数据分布方式，其方法是按照数据的某一特征计算哈希值，并将哈希值与机器中的机器建立映射关系，从而将不同哈希值的数据分布到不同的机器上。所谓数据特征可以是$$key-value$$系统中的key，也可以是其他与应用业务逻辑相关的值。例如: 一种常见的哈希方式是按数据属于的用户$$id$$计算哈希值,集群中的服务器按$$0$$到机器数减$$1$$编号，哈希值除以服务器的个数，结果的余数作为处理该数据的服务器编号。工程中往往需要考虑服务器的副本冗余，将每数台(例如$$3$$)服务器组成一组，用哈希值除以总的组数，其余数为服务器组的编号。下图给出了哈希方式分数据的一个例子，将数据按哈希值分配到4个节点上。

![](http://oh8mi0yav.bkt.clouddn.com/hash-method-of-data-spread.png)

<!--more-->

#### 优缺点
##### 优点: 
> 只要哈希函数的散列特性较好，哈希方式可以较为均匀的将数据分布到集群中去。需要记录的元信息也非常简单，任何时候，任何节点只需要知道哈希函数的计算方式及模的服务器总数就可以计算出处理具体数据的机器是哪台。

##### 缺点: 
> 可扩展性不高，一旦集群规模需要扩展，则几乎所有的数据需要被迁移并重新分布；另一方面一旦某数据特征值的数据严重不均，容易出现“数据倾斜”(data skew)问题。

![](http://oh8mi0yav.bkt.clouddn.com/userid-data-skew-in-distribute-system.png)

#### 整体性学习
> + 可以将哈希方式想象为一个大的哈希表，每台(组)机器就是一个哈希表中的桶，数据根据哈希值被分布到各个桶上面。
> + HashMap或者ConcurrentHashMap的具体实现在多台机器之间上的体现。

### 按数据范围分布
数据按特征值的值域范围划分为不同的区间，使得集群中每台(组)服务器处理不同区间的数据。例如: 已知某系统中用户$$id$$的值域范围是$$[1,100)$$，集群有$$3$$台服务器，使用按数据范围划分数据的数据分布方式。将用户$$id$$的值域分为三个区间$$[1, 33)、[33, 90)、[90, 100)$$分别由$$3$$台服务器负责处理，示意图如下:

![](http://oh8mi0yav.bkt.clouddn.com/data-distribute-in-bucket-of-userid.png)

> 为了数据迁移等负载均衡操作的方便，往往利用动态划分区间的技术，使得每个区间中服务的数据量尽量的一样多。当某个区间的数据量较大时，通过将区间“分裂”的方式拆分为两个区间，使得每个数据区间中的数据量都尽量维持在一个较为固定的阈值之下。

#### 优缺点
##### 优点
>最大优点就是可以灵活的根据数据量的具体情况拆分原有数据区间，拆分后的数据区间可以迁移到其他机器，一旦需要集群完成负载均衡时，与哈希方式相比非常灵活。当**集群需要扩容时，可以随意添加机器**，而不限为倍增的方式，只需将原机器上的部分数据分区迁移到新加入的机器上就可以完成集群扩容。

##### 缺点
> 需要使用专门的服务器在内存中维护数据分布信息，称这种数据的分布信息为一种元信息。甚至对于大规模的集群，由于元信息的规模非常庞大，单台计算机无法独立维护，需要使用多台机器作为元信息服务器。随着集群规模的增长，元数据服务器较为容易成为瓶颈，从而需要较为负责的多元数据服务器机制解决这个问题。

#### 整体性学习
> + 类似于$$B，B+$$树的数据结构分布，通过分摊上游数据，来使得每个数据区间中的数据量都尽量的分散。

### 按数据量分布
与哈希方式和按数据范围方式不同，数据量分布数据与具体的数据特征无关，而是将数据视为一个顺序增长的文件，并将这个文件按照某一较为固定的大小划分为若干数据块(chunk)，不同的数据块分布到不同的服务器上。与按数据范围分布数据的方式类似的是按数据量分布数据也需要记录数据块的具体分布情况，并将该分布信息作为元数据使用元数据服务器管理。

#### 优缺点
##### 优点

> + 与具体的数据内容无关，按数据量分布数据的方式一般没有数据倾斜的问题，数据总是被均匀切分并分布到集群中。
> + 集群需要重新负载均衡时，只需通过迁移数据块即可完成。

##### 缺点
> + 数据量划分数据的缺点是需要管理较为复杂的元信息，与按范围分布数据的方式类似，当集群规模较大时，元信息的数据量也变得很大，高效的管理元信息成为新的课题。

### 一致性Hash算法






