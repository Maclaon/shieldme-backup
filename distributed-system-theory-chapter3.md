---
title: 分布式理论（三）
date: 2015-01-28 10:00:00
tags: 分布式理论，数据分布
author: maclaon
comments: false
---
# 分布式系统原理
## 数据分布方式
利用多台计算机协同解决单台计算机不能解决的计算、存储等问题。将一个单机问题使用分布式解决，首先要解决的就是如何将问题拆解为可以使用多机分布式解决，使得分布式系统中的每台机器负责原问题的一个子集。所以单台机器上如何拆解具体的输入数据成为分布式系统的基本问题。这里介绍几种常用的数据拆解方式。

### 哈希方式
哈希方式是最常见的数据分布方式，其方法是按照数据的某一特征计算哈希值，并将哈希值与机器中的机器建立映射关系，从而将不同哈希值的数据分布到不同的机器上。所谓数据特征可以是$$key-value$$系统中的key，也可以是其他与应用业务逻辑相关的值。例如: 一种常见的哈希方式是按数据属于的用户$$id$$计算哈希值,集群中的服务器按$$0$$到机器数减$$1$$编号，哈希值除以服务器的个数，结果的余数作为处理该数据的服务器编号。工程中往往需要考虑服务器的副本冗余，将每数台(例如$$3$$)服务器组成一组，用哈希值除以总的组数，其余数为服务器组的编号。下图给出了哈希方式分数据的一个例子，将数据按哈希值分配到4个节点上。

![](http://oh8mi0yav.bkt.clouddn.com/hash-method-of-data-spread.png)

<!--more-->

#### 优缺点
##### 优点: 
> 只要哈希函数的散列特性较好，哈希方式可以较为均匀的将数据分布到集群中去。需要记录的元信息也非常简单，任何时候，任何节点只需要知道哈希函数的计算方式及模的服务器总数就可以计算出处理具体数据的机器是哪台。

##### 缺点: 
> 可扩展性不高，一旦集群规模需要扩展，则几乎所有的数据需要被迁移并重新分布；另一方面一旦某**数据特征值的数据严重不均**，容易出现“数据倾斜”(data skew)问题，比如内容生产中的某一个活跃用户（红人）产生的内容比较多，如果以`userId`来进行哈希的话，必然会导致某个表的数据存在量较大。**抛出另外一个问题: 如何让设计的数据结构在特征值上看起来是均匀分布的？**。

![](http://oh8mi0yav.bkt.clouddn.com/userid-data-skew-in-distribute-system.png)

#### 整体性学习
> + 可以将哈希方式想象为一个大的哈希表，每台(组)机器就是一个哈希表中的桶，数据根据哈希值被分布到各个桶上面。
> + HashMap或者ConcurrentHashMap的具体实现在多台机器之间上的体现。

### 按数据范围分布
数据按特征值的值域范围划分为不同的区间，使得集群中每台(组)服务器处理不同区间的数据。例如: 已知某系统中用户$$id$$的值域范围是$$[1,100)$$，集群有$$3$$台服务器，使用按数据范围划分数据的数据分布方式。将用户$$id$$的值域分为三个区间$$[1, 33)、[33, 90)、[90, 100)$$分别由$$3$$台服务器负责处理，示意图如下:

![](http://oh8mi0yav.bkt.clouddn.com/data-distribute-in-bucket-of-userid.png)

> 为了数据迁移等负载均衡操作的方便，往往利用动态划分区间的技术，使得每个区间中服务的数据量尽量的一样多。当某个区间的数据量较大时，通过将区间“分裂”的方式拆分为两个区间，使得每个数据区间中的数据量都尽量维持在一个较为固定的阈值之下。

#### 优缺点
##### 优点
>最大优点就是可以灵活的根据数据量的具体情况拆分原有数据区间，拆分后的数据区间可以迁移到其他机器，一旦需要集群完成负载均衡时，与哈希方式相比非常灵活。当**集群需要扩容时，可以随意添加机器**，而不限为倍增的方式，只需将原机器上的部分数据分区迁移到新加入的机器上就可以完成集群扩容。

##### 缺点
> 需要使用专门的服务器在内存中维护数据分布信息，称这种数据的分布信息为一种元信息。甚至对于大规模的集群，由于元信息的规模非常庞大，单台计算机无法独立维护，需要使用多台机器作为元信息服务器。随着集群规模的增长，元数据服务器较为容易成为瓶颈，从而需要较为负责的多元数据服务器机制解决这个问题。

#### 整体性学习
> + 类似于$$B，B+$$树的数据结构分布，通过分摊上游数据，来使得每个数据区间中的数据量都尽量的分散。

### 按数据量分布
与哈希方式和按数据范围方式不同，数据量分布数据与具体的数据特征无关，而是将数据视为一个顺序增长的文件，并将这个文件按照某一较为固定的大小划分为若干数据块(chunk)，不同的数据块分布到不同的服务器上。与按数据范围分布数据的方式类似的是按数据量分布数据也需要记录数据块的具体分布情况，并将该分布信息作为元数据使用元数据服务器管理。

#### 优缺点
##### 优点

> + 与具体的数据内容无关，按数据量分布数据的方式一般没有数据倾斜的问题，数据总是被均匀切分并分布到集群中。
> + 集群需要重新负载均衡时，只需通过迁移数据块即可完成。

##### 缺点
> + 数据量划分数据的缺点是需要管理较为复杂的元信息，与按范围分布数据的方式类似，当集群规模较大时，元信息的数据量也变得很大，高效的管理元信息成为新的课题，比如对某个字段进行查询和搜索成为新的问题。

#### 整体性学习
> + 类似于装水的桶，装满了进行运输的场景，但是对于具有特征值的桶的元素进行查找很难定位。可以对数据的查询进行倒排索引的构造，二级索引的构造，计算出数据的特征值，并根据特征值的方式进行索引。


### 一致性Hash算法
一致性哈希最初在$$P2P$$网络中作为分布式哈希表(DHT)的常用数据分布算法。一致性哈希的基本方式是使用一个哈希函数计算数据或数据特征的哈希值，令该哈希函数的输出值域为一个封闭的环，即哈希函数输出的最大值是最小值的前序。将节点随机分布到这个环上，每个节点负责处理从自己开始顺时针至下一个节点的全部哈希值域上的数据，[一致性Hash算法具体介绍](http://www.cnblogs.com/haippy/archive/2011/12/10/2282943.html)。

#### 整体性学习
> + Memcache的分布式机器寻找

## 副本与数据分布
> 分布式系统容错，提高可用性的基本手段就是使用副本。对于数据副本的分布方式主要影响系统的可扩展性。

一种基本的数据副本策略是以机器为单位，若干机器互为副本，副本机器之间的数据完全相同。这种策略适用上述各种数据分布方式。其优点是非常简单，其缺点是恢复数据的效率不高、可扩展性也不高。下图给出以机器为单位的副本例子，机器1、2、3互为副本，机器4、5、6互为副本，机器7、8、9互为副本

![](http://oh8mi0yav.bkt.clouddn.com/data-replica-in-one-machine.png)

上述系统主要有以下几个缺点：
+ 一旦出现副本数据丢失,需要恢复副本数据时效率不高。
+ 该种方式不利于提高系统扩展性。
+ 不利于系统容错。

> 更合适的做法不是以机器作为副本单位，而是将数据拆为较合理的数据段，以数据段为单位作为副本。

实践中，常常使得每个数据段的大小尽量相等且控制在一定的大小以内。数据段有很多不同的称谓$$segment、fragment、chunk、partition$$等等。

### 数据段选择
> 数据段的选择与数据分布方式直接相关。

+ 哈希数据分布方式: 每个哈希分桶后的余数可以作为一个数据段，为了控制数据段的大小，常常使得分桶个数大于集群规模。
+ 数据范围分布数据的方式: 可以将每个数据区间作为一个数据段，并控制数据区间中数据的大小。
+ 数据量分布数据的方式: 可以自然的按照每个数据块作为数据段。
+ 一致性哈希分布数据的方式: 通常的做法是讲一致性哈希环分为若干等长分区，分区个数一般远大于节点个数，假设哈希函数均匀，则每个分区中的数据可以作为一个数据段。

**一旦副本分布与机器无关，数据丢失后的恢复效率将非常高**。这是因为，一旦某台机器的数据丢失，其上数据段的副本将分布在整个集群的所有机器中，而不是仅在几个副本机器中，从而可以从整个集群同时拷贝恢复数据，而集群中每台数据源机器都可以以非常低的资源做拷贝。

缺点: 完全按照数据段建立副本会引起需要管理的元数据的开销增大，副本维护的难度也相应增大。

## 本地化计算
分布式系统中，数据的分布方式也深深影响着计算的分布方式。在分布式系统中计算节点和保存计算数据的存储节点可以在同一台物理机器上，也可以位于不同的物理机器。如果计算节点和存储节点位于不同的物理机器则计算的数据需要通过网络传输，此种方式的开销很大，甚至网络带宽会成为系统的总体瓶颈。另一种思路是，将计算尽量调度到与存储节点在同一台物理机器上的计算节点上进行，这称之为本地化计算。本地化计算是计算调度的一种重要优化，其体现了一种重要的分布式调度思想:“移动数据不如移动计算”。





